{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="text-gray-600 body-font overflow-hidden">
	<div class="container px-5 py-8 mx-auto">
	  <div class="flex justify-center">
		<div class="lg:w-4/5 flex flex-wrap justify-center">
		  <div class="w-full lg:pr-10 lg:py-6 mb-6 lg:mb-0">
			<h2 class="text-sm title-font text-gray-500 tracking-widest">LEAD</h2>
			<div class="flex items-center gap-4 mb-4">
			  <div class="w-20 h-20 rounded-full border-2 border-gray-300 bg-gray-200 overflow-hidden flex-shrink-0 flex items-center justify-center relative">
				{% if lead.profile_image %}
				  <img src="{{ lead.profile_image.url }}" alt="{{ lead.first_name }} {{ lead.last_name }}" class="w-full h-full object-cover absolute inset-0" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
				{% endif %}
				<img src="{% static 'images/crm-logo.png' %}" alt="Darkenyas CRM" class="w-full h-full object-cover" style="{% if lead.profile_image %}display:none;{% endif %}">
			  </div>
			  <h1 class="text-gray-900 text-3xl title-font font-medium">{{ lead.first_name }} {{ lead.last_name }}</h1>
			</div>
			<div class="flex mb-4">
			  <a href="{% url 'leads:lead-detail' lead.pk %}" class="flex-grow border-b-2 border-gray-300 py-2 text-lg px-1">
				Overview
			  </a>
			  <a href="{% url 'leads:lead-category-update' lead.pk %}" class="flex-grow border-b-2 border-gray-300 py-2 text-lg px-1">
				Category
			  </a>
			  {% if not request.user.is_agent %}
			  <a href="{% url 'leads:lead-update' lead.pk %}" class="flex-grow border-b-2 border-gray-300 py-2 text-lg px-1">
				Update Details
			  </a>
			  {% endif %}
			  <a href="{% url 'leads:lead-activity' lead.pk %}" class="flex-grow text-indigo-500 border-b-2 border-indigo-500 py-2 text-lg px-1">
				Lead Activity
			  </a>
			</div>

			<h3 class="text-lg font-semibold text-gray-800 mt-6 mb-3">Activity history</h3>
			<p class="text-sm text-gray-500 mb-4">All actions for this lead: creation, updates, orders.</p>

			<div class="overflow-x-auto">
			  <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
				<thead class="bg-gray-100">
				  <tr>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Date</th>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Action</th>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Object</th>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">User</th>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">Details</th>
					<th class="px-4 py-2 text-left text-sm font-medium text-gray-700">View</th>
				  </tr>
				</thead>
				<tbody>
				  {% for log in lead_activities %}
				  <tr class="border-t border-gray-200 hover:bg-gray-50">
					<td class="px-4 py-2 text-sm text-gray-600">{{ log.created_at|date:"d.m.Y H:i" }}</td>
					<td class="px-4 py-2 text-sm font-medium text-gray-900">{{ log.get_action_display }}</td>
					<td class="px-4 py-2 text-sm text-gray-700">{{ log.object_repr|default:"-" }}</td>
					<td class="px-4 py-2 text-sm">{{ log.user.get_full_name|default:log.user.username }}</td>
					<td class="px-4 py-2 text-sm text-gray-500">
					  {% if "changes" in log.details %}
						<span class="font-medium">{{ log.details.count }} product(s) updated</span>
						{% if log.details.reason %}<span class="text-gray-400"> — {{ log.details.reason|truncatewords:6 }}</span>{% endif %}
						<details class="mt-1 inline-block">
						  <summary class="cursor-pointer text-blue-600 hover:text-blue-800 select-none">Show</summary>
						  <ul class="mt-1 ml-2 list-disc list-inside max-h-48 overflow-y-auto text-xs space-y-0.5 border border-gray-200 rounded p-2 bg-gray-50">
							{% for c in log.details.changes %}
							<li>{{ c.name }}: {{ c.old_price|floatformat:2 }} → {{ c.new_price|floatformat:2 }}</li>
							{% endfor %}
							{% if log.details.truncated %}
							<li class="text-gray-500 italic">… (first 100 of {{ log.details.count }} total)</li>
							{% endif %}
						  </ul>
						</details>
					  {% elif "old_price" in log.details and "new_price" in log.details %}
						{{ log.details.old_price|floatformat:2 }} → {{ log.details.new_price|floatformat:2 }}{% if log.details.reason %} ({{ log.details.reason|truncatewords:8 }}){% endif %}
					  {% elif "reason" in log.details %}
						{{ log.details.reason|truncatewords:12 }}
					  {% elif log.details and log.details.items %}
						{% for key, val in log.details.items %}{% if not forloop.first %}; {% endif %}{{ key }}: {{ val }}{% endfor %}
					  {% else %}
						—
					  {% endif %}
					</td>
					<td class="px-4 py-2 text-sm">
					  {% if log.get_detail_url %}
						<a href="{{ log.get_detail_url }}" class="inline-flex items-center px-2 py-1 rounded text-sm font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition">View</a>
					  {% else %}
						<span class="text-gray-400">—</span>
					  {% endif %}
					</td>
				  </tr>
				  {% empty %}
				  <tr>
					<td colspan="6" class="px-4 py-8 text-center text-gray-500">No activity records for this lead yet.</td>
				  </tr>
				  {% endfor %}
				</tbody>
			  </table>
			</div>

			<div class="mt-6">
			  <a class="hover:text-blue-500" href="{% url 'leads:lead-list' %}">Back to all leads</a>
			</div>
		  </div>
		</div>
	  </div>
	</div>
</section>
{% endblock content %}
