{% extends "base.html" %}

{% block content %}

<style>
/* Add custom CSS here */
.view-lead-link:hover, .assign-agent-link:hover {
    color: #00008B; /* Dark blue color for hover state */
}
</style>

<section class="text-gray-600 body-font">
     <div class="container px-5 py-24 mx-auto flex flex-wrap">
          <div class="w-full mb-6 py-6 flex justify-between items-center border-b border-gray-200">
               <div>
                    <h1 class="text-4xl text-gray-800">Leads</h1>
                    <a class="text-gray-500 hover:text-blue-500" href="{% url 'leads:category-list' %}">View categories</a>
               </div>
               {% if request.user.is_organisor %}
               <div>
                    <a class="text-gray-500 hover:text-blue-500" href="{% url 'leads:lead-create' %}">Create a new lead</a>
               </div>
               {% endif %}
          </div>

          <!-- Search & filters -->
          <div class="w-full mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
               <form method="get" action="{% url 'leads:lead-list' %}" class="flex flex-wrap items-end gap-3">
                    <div class="flex-1 min-w-[200px]">
                         <label for="lead-search" class="block text-sm font-medium text-gray-700 mb-1">Ara</label>
                         <input type="text" name="q" id="lead-search" value="{{ search_query }}"
                                placeholder="İsim, soyisim, e-posta veya telefon..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    {% if request.user.is_superuser %}
                    <div>
                         <label for="lead-org" class="block text-sm font-medium text-gray-700 mb-1">Organisation</label>
                         <select name="organisation" id="lead-org" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                              <option value="">Tümü</option>
                              {% for org in filter_organisations %}
                              <option value="{{ org.id }}" {% if current_organisation_id == org.id|stringformat:"s" %}selected{% endif %}>{{ org.user.username }}</option>
                              {% endfor %}
                         </select>
                    </div>
                    <div>
                         <label for="lead-agent" class="block text-sm font-medium text-gray-700 mb-1">Agent</label>
                         <select name="agent" id="lead-agent" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                              <option value="">Tümü</option>
                              {% for agent in filter_agents %}
                              <option value="{{ agent.id }}" data-organisation-id="{{ agent.organisation_id }}" {% if current_agent_id == agent.id|stringformat:"s" %}selected{% endif %}>{{ agent.user.username }} ({{ agent.organisation.user.username }})</option>
                              {% endfor %}
                         </select>
                    </div>
                    {% elif request.user.is_organisor and filter_agents %}
                    <div>
                         <label for="lead-agent-organisor" class="block text-sm font-medium text-gray-700 mb-1">Agent</label>
                         <select name="agent" id="lead-agent-organisor" class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                              <option value="">Tümü</option>
                              {% for agent in filter_agents %}
                              <option value="{{ agent.id }}" {% if current_agent_id == agent.id|stringformat:"s" %}selected{% endif %}>{{ agent.user.username }}</option>
                              {% endfor %}
                         </select>
                    </div>
                    {% endif %}
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Filtrele</button>
                    {% if search_query or current_organisation_id or current_agent_id %}
                    <a href="{% url 'leads:lead-list' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Temizle</a>
                    {% endif %}
               </form>
          </div>

          {% if request.user.is_superuser %}
          <script>
          (function() {
               var orgSelect = document.getElementById('lead-org');
               var agentSelect = document.getElementById('lead-agent');
               if (!orgSelect || !agentSelect) return;
               function filterAgentsByOrg() {
                    var orgId = orgSelect.value;
                    var options = agentSelect.querySelectorAll('option[data-organisation-id]');
                    options.forEach(function(opt) {
                         var show = !orgId || opt.getAttribute('data-organisation-id') === orgId;
                         opt.style.display = show ? '' : 'none';
                         opt.disabled = !show;
                    });
                    if (orgId) {
                         var currentOpt = agentSelect.options[agentSelect.selectedIndex];
                         if (currentOpt && currentOpt.getAttribute('data-organisation-id') !== orgId) {
                              agentSelect.value = '';
                         }
                    }
               }
               orgSelect.addEventListener('change', filterAgentsByOrg);
               filterAgentsByOrg();
          })();
          </script>
          {% endif %}

          <div class="flex flex-wrap -m-4">
               {% for lead in leads %}
               <div class="p-4 w-full">
                    <div class="flex border-2 rounded-lg border-gray-600 p-8 sm:flex-row flex-col">
                         <div class="w-16 h-16 sm:mr-8 sm:mb-0 mb-4 rounded-full overflow-hidden flex-shrink-0 bg-indigo-100 flex items-center justify-center">
                              {% if lead.profile_image %}
                              <img src="{{ lead.profile_image.url }}" alt="{{ lead.first_name }} {{ lead.last_name }}" class="w-full h-full object-cover">
                              {% else %}
                              <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                              {% endif %}
                         </div>
                         <div class="flex-grow">
                              <h2 class="text-gray-900 text-lg title-font font-medium mb-3">{{ lead.first_name }} {{ lead.last_name }}</h2>
                              <div class="leading-relaxed text-base mb-3">
                                   <p class="mb-1"><strong>Email:</strong> {{ lead.email|default:"Not provided" }}</p>
                                   <p class="mb-1"><strong>Phone:</strong> {{ lead.phone_number|default:"Not provided" }}</p>
                                   <p class="mb-1"><strong>Source:</strong> <span class="text-blue-600 font-medium">{{ lead.source_category.name|default:"Unassigned" }}</span></p>
                                   <p class="mb-1"><strong>Value:</strong> <span class="text-green-600 font-medium">{{ lead.value_category.name|default:"Unassigned" }}</span></p>
                                   {% if lead.agent %}
                                   <p class="mb-1"><strong>Agent:</strong> <span class="text-purple-600 font-medium">{{ lead.agent.user.username }}</span></p>
                                   {% endif %}
                                   {% if request.user.is_superuser %}
                                   <p class="mb-1"><strong>Organisation:</strong> <span class="text-orange-600 font-medium">{{ lead.organisation.user.username }}</span></p>
                                   {% endif %}
                              </div>
                              <a href="{% url 'leads:lead-detail' lead.pk %}" class="view-lead-link mt-3 text-indigo-500 inline-flex items-center hover:text-blue-900">View this lead
                                   <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-4 h-4 ml-2" viewBox="0 0 24 24">
                                        <path d="M5 12h14M12 5l7 7-7 7"></path>
                                   </svg>
                              </a>
                         </div>
                    </div>
               </div>
               {% endfor %}
          </div>
          <!-- Unassigned Leads Section -->
          {% if unassigned_leads.exists %}
          <div class="w-full mt-12 mb-6">
               <h1 class="text-4xl text-gray-800 mb-6">Unassigned Leads</h1>
          </div>
          <div class="flex flex-wrap -m-4">
               {% for lead in unassigned_leads %}
               <div class="p-4 w-full">
                    <div class="flex border-2 rounded-lg border-gray-600 p-8 sm:flex-row flex-col">
                         <div class="w-16 h-16 sm:mr-8 sm:mb-0 mb-4 rounded-full overflow-hidden flex-shrink-0 bg-indigo-100 flex items-center justify-center">
                              {% if lead.profile_image %}
                              <img src="{{ lead.profile_image.url }}" alt="{{ lead.first_name }} {{ lead.last_name }}" class="w-full h-full object-cover">
                              {% else %}
                              <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-8 h-8 text-indigo-500" viewBox="0 0 24 24"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                              {% endif %}
                         </div>
                         <div class="flex-grow">
                              <h2 class="text-gray-900 text-lg title-font font-medium mb-3">{{ lead.first_name }} {{ lead.last_name }}</h2>
                              <div class="leading-relaxed text-base mb-3">
                                   <p class="mb-1"><strong>Email:</strong> {{ lead.email|default:"Not provided" }}</p>
                                   <p class="mb-1"><strong>Phone:</strong> {{ lead.phone_number|default:"Not provided" }}</p>
                                   <p class="mb-1"><strong>Source:</strong> <span class="text-blue-600 font-medium">{{ lead.source_category.name|default:"Unassigned" }}</span></p>
                                   <p class="mb-1"><strong>Value:</strong> <span class="text-green-600 font-medium">{{ lead.value_category.name|default:"Unassigned" }}</span></p>
                                   <p class="mb-1"><strong>Status:</strong> <span class="text-red-600 font-medium">Unassigned Agent</span></p>
                                   {% if request.user.is_superuser %}
                                   <p class="mb-1"><strong>Organisation:</strong> <span class="text-orange-600 font-medium">{{ lead.organisation.user.username }}</span></p>
                                   {% endif %}
                              </div>
                              <a href="{% url 'leads:lead-detail' lead.pk %}" class="view-lead-link mt-3 text-indigo-500 inline-flex items-center hover:text-blue-900">View this lead
                                   <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-4 h-4 ml-2" viewBox="0 0 24 24">
                                        <path d="M5 12h14M12 5l7 7-7 7"></path>
                                   </svg>
                              </a>
                              <span class="mx-2">|</span>
                              <a href="{% url 'leads:assign-agent' lead.pk %}" class="assign-agent-link mt-3 text-indigo-500 inline-flex items-center hover:text-blue-900">Assign Agent
                                   <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-4 h-4 ml-2" viewBox="0 0 24 24">
                                        <path d="M5 12h14M12 5l7 7-7 7"></path>
                                   </svg>
                              </a>
                         </div>
                    </div>
               </div>
               {% endfor %}
          </div>
          {% endif %}
     </div>
</section>

{% endblock content %}