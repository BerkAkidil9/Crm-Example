{% extends "base.html" %}
{% load tailwind_filters %}
{% load crispy_forms_tags %}
{% block content %}

<style>
    /* Phone number widget styling */
    select[id*="phone_number"] {
        font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif !important;
        font-size: 14px !important;
        background-color: white !important;
        border: 1px solid #d1d5db !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
    }
    
    /* Ensure emojis are displayed properly */
    select[id*="phone_number"] option {
        font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif !important;
        padding: 4px 8px !important;
    }
    
    /* Phone input styling */
    input[id*="phone_number"] {
        border: 1px solid #d1d5db !important;
        border-radius: 6px !important;
        padding: 8px 12px !important;
    }
</style>

<div class="max-w-lg mx-auto">

    <a class="hover:text-blue-500" href="{% url 'leads:lead-list' %}">Back to all leads</a>
    <div class="py-5 border-t border-gray-200">
        <h1 class="text-2xl text-gray-800">Create a new lead </h1>
        </div>
    <form method="post" class="mt-5" enctype="multipart/form-data">
        {% csrf_token %}
        {% if form.profile_image %}
        <div class="mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <label class="block text-sm font-medium text-gray-700 mb-2">Profile photo *</label>
            <div class="flex items-center gap-4 flex-wrap">
                <div class="w-24 h-24 rounded-full border-2 border-gray-300 bg-gray-200 overflow-hidden flex items-center justify-center shrink-0">
                    <img id="lead-profile-preview" src="" alt="Preview" class="w-full h-full object-cover hidden">
                    <span id="lead-profile-placeholder" class="text-gray-400 text-xs text-center px-2">No image selected</span>
                </div>
                <div class="flex-1 min-w-0">
                    {{ form.profile_image }}
                    <p class="text-xs text-gray-500 mt-1">{{ form.profile_image.help_text }}</p>
                    {% if form.profile_image.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.profile_image.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% for field in form %}
          {% if field.name != 'profile_image' %}
          <div class="mb-3">
            {{ field|as_crispy_field }}
          </div>
          {% endif %}
        {% endfor %}
        <button type="submit" class="w-full text-white bg-blue-500 hover:bg-blue-600 px-3 py-2 rounded-md">Create</button>
    </form>
</div>

<script>
// For admin: when organisation selection changes, update agents
document.addEventListener('DOMContentLoaded', function() {
    const organisationSelect = document.getElementById('id_organisation');
    const agentSelect = document.getElementById('id_agent');
    const sourceCategorySelect = document.getElementById('id_source_category');
    const valueCategorySelect = document.getElementById('id_value_category');
    
    function fillAgentsAndCategories(orgId) {
        if (!orgId || !agentSelect) return;
        agentSelect.innerHTML = '<option value="">Loading...</option>';
        if (sourceCategorySelect) sourceCategorySelect.innerHTML = '<option value="">Loading...</option>';
        if (valueCategorySelect) valueCategorySelect.innerHTML = '<option value="">Loading...</option>';
        fetch(`/leads/get-agents-by-org/${orgId}/`)
            .then(response => {
                if (!response.ok) return response.json().then(err => { throw new Error(err.error || response.status); });
                return response.json();
            })
            .then(data => {
                if (!data || data.error) {
                    throw new Error(data ? data.error : 'Invalid response');
                }
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                (data.agents || []).forEach(agent => {
                    agentSelect.innerHTML += `<option value="${agent.id}">${agent.name}</option>`;
                });
                if (sourceCategorySelect) {
                    sourceCategorySelect.innerHTML = '<option value="">Select Source Category</option>';
                    (data.source_categories || []).forEach(cat => {
                        sourceCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                }
                if (valueCategorySelect) {
                    valueCategorySelect.innerHTML = '<option value="">Select Value Category</option>';
                    (data.value_categories || []).forEach(cat => {
                        valueCategorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                agentSelect.innerHTML = '<option value="">Error loading</option>';
                if (sourceCategorySelect) sourceCategorySelect.innerHTML = '<option value="">Error loading</option>';
                if (valueCategorySelect) valueCategorySelect.innerHTML = '<option value="">Error loading</option>';
            });
    }
    if (organisationSelect && agentSelect) {
        organisationSelect.addEventListener('change', function() {
            const orgId = this.value;
            if (orgId) fillAgentsAndCategories(orgId);
            else {
                agentSelect.innerHTML = '<option value="">Select Agent</option>';
                if (sourceCategorySelect) sourceCategorySelect.innerHTML = '<option value="">Select Source Category</option>';
                if (valueCategorySelect) valueCategorySelect.innerHTML = '<option value="">Select Value Category</option>';
            }
        });
    }
    var profileInput = document.getElementById('id_lead_profile_image');
    if (profileInput) {
        var preview = document.getElementById('lead-profile-preview');
        var placeholder = document.getElementById('lead-profile-placeholder');
        profileInput.addEventListener('change', function(e) {
            var file = e.target.files && e.target.files[0];
            if (file && file.type.indexOf('image/') === 0) {
                var reader = new FileReader();
                reader.onload = function(ev) {
                    preview.src = ev.target.result;
                    preview.classList.remove('hidden');
                    if (placeholder) placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else if (preview && !file) {
                preview.src = '';
                preview.classList.add('hidden');
                if (placeholder) placeholder.classList.remove('hidden');
            }
        });
    }
});
</script>

{% endblock content %}


