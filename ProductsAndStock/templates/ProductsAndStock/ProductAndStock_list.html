{% extends "base.html" %}

{% block content %}
<section class="text-gray-600 body-font">
    <div class="container px-5 py-24 mx-auto">
        <div class="w-full mb-6 py-6 flex justify-between items-center border-b border-gray-200">
            <div>
                <h1 class="text-4xl text-gray-800">Products and Stock</h1>
            </div>
            <div class="flex space-x-4">
                {% if request.user.is_organisor or request.user.is_superuser %}
                <a class="text-gray-500 hover:text-purple-500" href="{% url 'ProductsAndStock:sales-dashboard' %}">ðŸ“Š Dashboard</a>
                <a class="text-gray-500 hover:text-amber-500" href="{% url 'ProductsAndStock:product-charts' %}">ðŸ“‰ Charts</a>
                <a class="text-gray-500 hover:text-green-500" href="{% url 'ProductsAndStock:bulk-price-update' %}">ðŸ“ˆ Bulk Price Update</a>
                <a class="text-gray-500 hover:text-blue-500" href="{% url 'ProductsAndStock:ProductAndStock-create' %}">Add a new product</a>
                {% endif %}
            </div>
        </div>
        
        <!-- Category, Name & Organisor Filter -->
        <div class="mb-6 bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">Filter by Name & Category{% if request.user.is_superuser %} & Organisor{% endif %}</h3>
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-48">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" name="search" id="search" value="{{ search_query }}" placeholder="Search by product name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                {% if request.user.is_superuser %}
                <div class="flex-1 min-w-48">
                    <label for="organisation" class="block text-sm font-medium text-gray-700 mb-1">Organisor</label>
                    <select name="organisation" id="organisation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Organisors</option>
                        {% for org in organisations %}
                        <option value="{{ org.id }}" {% if selected_organisation_id == org.id|stringformat:"s" %}selected{% endif %}>
                            {{ org.user.username }}{% if org.user.email %} ({{ org.user.email }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="flex-1 min-w-48">
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select name="category" id="category" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category_id == category.id|stringformat:"s" %}selected{% endif %}>
                            {% if category.icon %}<i class="{{ category.icon }} mr-1"></i>{% endif %}{{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-1 min-w-48">
                    <label for="subcategory" class="block text-sm font-medium text-gray-700 mb-1">Sub Category</label>
                    <select name="subcategory" id="subcategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Sub Categories</option>
                        {% for subcategory in subcategories %}
                        <option value="{{ subcategory.id }}" {% if selected_subcategory_id == subcategory.id|stringformat:"s" %}selected{% endif %}>
                            {{ subcategory.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Filter
                    </button>
                    <a href="{% url 'ProductsAndStock:ProductAndStock-list' %}" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Clear
                    </a>
                </div>
            </form>
        </div>
        <!-- Products Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for product in object_list %}
            <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow duration-200">
                <!-- Product Header -->
                <div class="p-4 border-b border-gray-100">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="w-10 h-10 flex-shrink-0 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-box text-purple-600"></i>
                            </div>
                            <div class="min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 truncate">{{ product.product_name }}</h3>
                                <p class="text-sm text-gray-500 truncate">{{ product.product_description }}</p>
                            </div>
                        </div>
                        {% if product.cost_price > 0 %}
                        <div class="flex-shrink-0 text-right whitespace-nowrap">
                            <span class="text-sm font-medium text-green-600">{{ product.profit_margin_percentage|floatformat:1 }}%</span>
                            <div class="text-xs text-gray-500">profit</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Product Info -->
                <div class="p-4">
                    <!-- Category -->
                    <div class="mb-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {% if product.category.icon %}<i class="{{ product.category.icon }} mr-1"></i>{% endif %}
                            {{ product.category.name }} - {{ product.subcategory.name }}
                        </span>
                    </div>

                    <!-- Price -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                            <span class="text-2xl font-bold text-gray-900">${{ product.product_price|floatformat:2 }}</span>
                            {% if product.discount_percentage > 0 or product.discount_amount > 0 %}
                            <span class="text-sm text-green-600 font-medium">${{ product.discounted_price|floatformat:2 }}</span>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                {% if product.discount_percentage > 0 %}{{ product.discount_percentage }}% off{% endif %}
                                {% if product.discount_amount > 0 %}{% if product.discount_percentage > 0 %} + {% endif %}${{ product.discount_amount|floatformat:0 }}{% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    {% if product.discount_percentage > 0 or product.discount_amount > 0 %}
                    {% if product.discount_start_date or product.discount_end_date %}
                    <p class="text-xs text-gray-500 mb-2">
                        Discount period: {% if product.discount_start_date %}{{ product.discount_start_date|date:"M d, Y" }}{% endif %}
                        {% if product.discount_start_date and product.discount_end_date %} â€“ {% endif %}
                        {% if product.discount_end_date %}{{ product.discount_end_date|date:"M d, Y" }}{% endif %}
                    </p>
                    {% endif %}
                    {% endif %}

                    <!-- Stock Info -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="{% if product.stock_status == 'Out of Stock' %}text-red-600{% elif product.stock_status == 'Low Stock' %}text-orange-600{% elif product.stock_status == 'Overstock' %}text-amber-600{% else %}text-green-600{% endif %} font-medium">
                                {{ product.product_quantity }} units
                            </span>
                            <span class="px-2 py-1 text-xs rounded-full {% if product.stock_status == 'Out of Stock' %}bg-red-100 text-red-800{% elif product.stock_status == 'Low Stock' %}bg-orange-100 text-orange-800{% elif product.stock_status == 'Overstock' %}bg-amber-100 text-amber-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {{ product.stock_status }}
                            </span>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-medium text-blue-600">{{ product.total_sales_count }}</span>
                            <div class="text-xs text-gray-500">sold</div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-center p-2 bg-gray-50 rounded">
                            <div class="font-medium text-purple-600">${{ product.total_value|floatformat:2 }}</div>
                            <div class="text-xs text-gray-500">Total Value</div>
                        </div>
                        <div class="text-center p-2 bg-gray-50 rounded">
                            <div class="font-medium text-green-600">${{ product.total_revenue_from_sales|floatformat:2 }}</div>
                            <div class="text-xs text-gray-500">Revenue</div>
                        </div>
                    </div>

                    {% if request.user.is_superuser %}
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-500">Organisation: </span>
                        <span class="text-xs font-medium text-purple-600">{{ product.organisation.user.username }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Footer -->
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                    <a href="{% url 'ProductsAndStock:ProductAndStock-detail' product.pk %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-center py-2 px-4 rounded-md text-sm font-medium transition-colors duration-200 inline-flex items-center justify-center">
                        View Details
                        <svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="w-4 h-4 ml-2" viewBox="0 0 24 24">
                            <path d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category');
    const subcategorySelect = document.getElementById('subcategory');
    
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        const currentUrl = new URL(window.location);
        
        if (categoryId) {
            currentUrl.searchParams.set('category', categoryId);
            currentUrl.searchParams.delete('subcategory');
        } else {
            currentUrl.searchParams.delete('category');
            currentUrl.searchParams.delete('subcategory');
        }
        // Preserve search (name) when changing category
        const searchInput = document.getElementById('search');
        if (searchInput && searchInput.value.trim()) {
            currentUrl.searchParams.set('search', searchInput.value.trim());
        }
        window.location.href = currentUrl.toString();
    });
});
</script>
{% endblock content %}